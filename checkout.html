<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Timalsina Masala</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .checkout-wrapper { display:flex; gap:30px; flex-wrap:wrap; }
    .checkout-form, .order-summary { flex:1 1 320px; background:rgba(255,255,255,0.95); padding:20px; border-radius:8px; }
    .order-summary ul { list-style:none; padding:0; margin:0; }
    .order-summary li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;}
    .payment-btn { width:100%; padding:12px; background:#b64323; color:white; border:none; border-radius:5px; cursor:pointer; font-size:1rem; }
    .note { color:#555; font-size:0.9rem; margin-top:10px; }
  </style>
</head>
<body>
  <div class="checkout-container">
    <h2>Checkout</h2>
    <div class="checkout-wrapper">
      <div class="checkout-form">
        <form id="checkout-form">
          <label for="fullname">Full Name</label>
          <input type="text" id="fullname" required>

          <label for="email">Email</label>
          <input type="email" id="email" required>

          <label for="address">Shipping Address</label>
          <input type="text" id="address" required>

          <label for="city">City</label>
          <input type="text" id="city" required>

          <label for="payment">Payment Method</label>
          <select id="payment" required>
            <option value="">-- Select --</option>
            <option value="card">Credit/Debit Card</option>
            <option value="khalti">Khalti</option>
            <option value="esewa">eSewa</option>
            <option value="cod">Cash on Delivery</option>
          </select>

          <button type="submit" class="payment-btn">Place Order</button>
          <div class="note">This is a demo checkout. Payment is simulated. If a backend is available the order will be sent to it for persistence.</div>
        </form>
      </div>

      <div class="order-summary">
        <h3>Order Summary</h3>
        <div id="order-items">
          <em>Loading cart...</em>
        </div>
        <p style="margin-top:12px;"><strong>Total: $<span id="order-total">0.00</span></strong></p>
      </div>
    </div>
  </div>

  <script>
    // Utilities to load/save cart and form data
    function loadCart() {
      try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch (e) { return []; }
    }
    function saveCart(cart) { localStorage.setItem('cart', JSON.stringify(cart)); }
    function clearCart() { localStorage.removeItem('cart'); }

    function loadForm() {
      try { return JSON.parse(localStorage.getItem('checkoutForm') || '{}'); } catch (e) { return {}; }
    }
    function saveForm(data) { localStorage.setItem('checkoutForm', JSON.stringify(data)); }

    // Render order summary
    function renderOrder() {
      const cart = loadCart();
      const container = document.getElementById('order-items');
      const totalEl = document.getElementById('order-total');
      if (!cart || cart.length === 0) {
        container.innerHTML = '<p>Your cart is empty. Go back to <a href="shop.html">Shop</a>.</p>';
        totalEl.textContent = '0.00';
        return;
      }
      let sum = 0;
      const ul = document.createElement('ul');
      ul.innerHTML = '';
      cart.forEach(item => {
        const li = document.createElement('li');
        li.style.listStyle = 'none';
        li.innerHTML = `<span>${item.name} Ã— ${item.qty}</span><span>$${(item.price * item.qty).toFixed(2)}</span>`;
        ul.appendChild(li);
        sum += item.price * item.qty;
      });
      container.innerHTML = '';
      container.appendChild(ul);
      totalEl.textContent = sum.toFixed(2);
    }

    // Prefill form from localStorage
    const form = document.getElementById('checkout-form');
    const fields = ['fullname','email','address','city','payment'];
    function prefill() {
      const saved = loadForm();
      fields.forEach(f => {
        if (saved[f]) {
          const el = document.getElementById(f);
          if (el) el.value = saved[f];
        }
      });
    }
    // Auto-save form as user types
    fields.forEach(f => {
      const el = document.getElementById(f);
      if (el) {
        el.addEventListener('input', () => {
          const current = loadForm();
          current[f] = el.value;
          saveForm(current);
        });
      }
    });

    async function postOrderToServer(order) {
      try {
        const resp = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
        if (!resp.ok) throw new Error('Server returned ' + resp.status);
        const data = await resp.json();
        return data; // should contain id
      } catch (err) {
        console.warn('Could not send order to backend:', err);
        return null;
      }
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const cart = loadCart();
      if (!cart || cart.length === 0) {
        alert('Your cart is empty. Please add items before placing an order.');
        return;
      }
      // Basic validation (HTML validation handled too)
      const data = {};
      fields.forEach(f => data[f] = document.getElementById(f).value.trim());
      if (!data.fullname || !data.email || !data.address || !data.city || !data.payment) {
        alert('Please complete all fields.');
        return;
      }
      // Build order
      const total = document.getElementById('order-total').textContent;
      const order = {
        id: 'ORD-' + Date.now(),
        created_at: new Date().toISOString(),
        customer: data,
        items: cart,
        total: total
      };

      // Try to POST to backend (if you run the server)
      const serverResp = await postOrderToServer(order);
      if (serverResp && serverResp.id) {
        // server returned canonical id (overwrite)
        order.id = serverResp.id;
      }

      // Save last order for static demo/receipt
      localStorage.setItem('lastOrder', JSON.stringify(order));
      // Clear cart and checkout form storage
      clearCart();
      localStorage.removeItem('checkoutForm');

      // Redirect to order confirmation page
      window.location.href = 'order.html';
    });

    // initial load
    renderOrder();
    prefill();
  </script>
</body>
</html>