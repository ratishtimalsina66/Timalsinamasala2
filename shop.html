<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shop - Timalsina Masala</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Page-specific styles: gallery, search, product grid */
    .top-controls {
      max-width: 1000px;
      margin: 22px auto;
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
    }
    .search-wrap {
      flex: 1 1 560px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    #search-input {
      width:100%;
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:1rem;
    }
    .filters {
      display:flex;
      gap:8px;
      align-items:center;
    }
    .gallery {
      max-width: 1000px;
      margin: 12px auto;
      background: rgba(255,255,255,0.95);
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }
    .gallery-main {
      flex: 1 1 560px;
      min-height: 220px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#f4efe9;
      border-radius:8px;
      overflow:hidden;
    }
    .gallery-main img { width:100%; height:100%; object-fit:cover; display:block; }
    .gallery-thumbs {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex: 0 0 240px;
      flex-wrap:wrap;
    }
    .thumb {
      width:110px;
      height:70px;
      border-radius:6px;
      overflow:hidden;
      cursor:pointer;
      border:2px solid transparent;
    }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .thumb.active { border-color:#3e7d16; }

    .shop-container {
      max-width: 1000px;
      margin: auto;
      padding: 10px 20px 60px;
    }

    .product-list {
      margin-top: 18px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap:18px;
    }

    .product-item {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.06);
      padding: 14px;
      text-align: left;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .product-thumb {
      width:100%;
      height:140px;
      object-fit:cover;
      border-radius:6px;
      display:block;
      background:#f2e9df;
    }
    .product-meta { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .product-name { font-family: 'Georgia', serif; color:#2b4f13; margin:0; font-size:1.05rem; }
    .nepali-name { color:#666; font-size:0.92rem; margin-top:4px; }
    .desc { color:#555; font-size:0.95rem; margin:6px 0 0; flex:1; }
    .product-bottom { display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:8px; }
    .add-btn { background:#3e7d16; color:white; padding:10px 12px; border:none; border-radius:6px; cursor:pointer; }
    .price { font-weight:700; color:#b64323; }

    /* Cart area */
    #cart { margin-top: 30px; background:#faf7f3; padding:12px; border-radius:8px; }
    .cart-item { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee; }
    .cart-controls { display:flex; gap:8px; align-items:center; }

    @media (max-width:700px) {
      .gallery-thumbs { flex:1 1 100%; justify-content:center; }
      .top-controls { flex-direction:column; align-items:stretch; gap:10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Timalsina <span>MASALA</span></div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        <li><a href="checkout.html">Checkout</a></li>
        <li><a href="shop.html" class="cart-badge" title="View cart">Cart (<span id="cart-count">0</span>)</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Gallery / placeholder above listed spices -->
    <section class="gallery" aria-label="Featured spice images">
      <div class="gallery-main" id="gallery-main">
        <!-- Main image injected by JS -->
        <img src="images/placeholder.svg" alt="Featured spice" id="main-image">
      </div>
      <div class="gallery-thumbs" id="gallery-thumbs" aria-hidden="false">
        <!-- Thumbnails generated by JS -->
      </div>
    </section>

    <!-- Search + Filters -->
    <div class="top-controls" role="region" aria-label="Search and filters">
      <div class="search-wrap">
        <input id="search-input" type="search" placeholder="Search spices by English name, Nepali name or keyword (e.g. 'timur', 'haldi')" aria-label="Search spices">
      </div>
      <div class="filters">
        <label for="sort">Sort:</label>
        <select id="sort" aria-label="Sort products">
          <option value="popular">Recommended</option>
          <option value="az">Name A → Z</option>
          <option value="za">Name Z → A</option>
          <option value="price-asc">Price ↑</option>
          <option value="price-desc">Price ↓</option>
        </select>
      </div>
    </div>

    <div class="shop-container">
      <h2 class="shop-header">All Nepali Spices</h2>

      <!-- Product grid -->
      <div class="product-list" id="product-list">
        <!-- JS will render products here -->
      </div>

      <!-- Cart / quick checkout -->
      <div id="cart" aria-live="polite">
        <h3>Your Cart</h3>
        <div id="cart-items"></div>
        <p><strong>Total: $<span id="total">0.00</span></strong></p>
        <div style="text-align:center;">
          <button id="proceed-checkout" style="background-color:#b64323;color:white;padding:12px 24px;border:none;border-radius:6px;cursor:pointer;">Proceed to Checkout</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Timalsina Masala. All rights reserved.</p>
  </footer>

  <script>
    /*************************************************************************
     * PRODUCTS - Nepali spices list. Image fields use Unsplash source URLs so
     * real photos appear immediately. If you prefer local files, download each
     * URL and save it under images/ with the same filename (e.g. images/haldi.jpg).
     *
     * Example: open the URL in browser, right-click -> Save image as -> save to images/haldi.jpg
     *************************************************************************/
    const PRODUCTS = [
      { id: 'haldi', name: 'Turmeric Powder', nepali: 'Haldi', dev: 'हल्दी', desc: 'Bright yellow turmeric powder for curries, pickles and health uses.', price: 2.49, image: 'https://source.unsplash.com/800x600/?turmeric,powder', alt: 'Turmeric powder in a wooden bowl' },
      { id: 'jeera', name: 'Cumin (Jeera)', nepali: 'Jeera', dev: 'जीरा', desc: 'Cumin seeds and powder — warm, earthy flavour for dals and curries.', price: 3.99, image: 'https://source.unsplash.com/800x600/?cumin,seeds', alt: 'Cumin seeds and powder' },
      { id: 'dhaniya', name: 'Coriander (Dhaniya)', nepali: 'Dhaniya', dev: 'धनिया', desc: 'Coriander seeds and ground powder — citrusy, used in masalas and chutneys.', price: 3.49, image: 'https://source.unsplash.com/800x600/?coriander,seed,powder', alt: 'Coriander powder and seeds' },
      { id: 'chilli', name: 'Red Chilli Powder', nepali: 'Khursani', dev: 'खुर्सानी', desc: 'Powdered red chilies for heat and color.', price: 2.99, image: 'https://source.unsplash.com/800x600/?chili,powder,red', alt: 'Red chilli powder' },
      { id: 'marich', name: 'Black Pepper', nepali: 'Marich', dev: 'मरिच', desc: 'Whole or ground black pepper for spice and warmth.', price: 4.29, image: 'https://source.unsplash.com/800x600/?blackpepper,peppercorns', alt: 'Black peppercorns in a bowl' },
      { id: 'rai', name: 'Mustard Seeds', nepali: 'Rai / Tori', dev: 'राई / तोरी', desc: 'Brown/black/yellow mustard seeds for tempering and pickles.', price: 2.19, image: 'https://source.unsplash.com/800x600/?mustard,seeds', alt: 'Mustard seeds' },
      { id: 'methi', name: 'Fenugreek Seeds', nepali: 'Methi', dev: 'मेथी', desc: 'Bitter aromatic seeds used in dals, vegetable dishes and pickles.', price: 2.79, image: 'https://source.unsplash.com/800x600/?fenugreek,seeds', alt: 'Fenugreek seeds' },
      { id: 'kasuri-methi', name: 'Kasuri Methi (dried fenugreek leaves)', nepali: 'Kasuri Methi', dev: 'कसुरी मेथी', desc: 'Dried methi leaves used to finish curries with a unique aroma.', price: 3.29, image: 'https://source.unsplash.com/800x600/?dried,fenugreek,leaves', alt: 'Dried fenugreek leaves' },
      { id: 'saunf', name: 'Fennel (Saunf)', nepali: 'Saunf', dev: 'सौंफ', desc: 'Sweet fennel seed for spice blends, chutneys and mouth freshener.', price: 2.99, image: 'https://source.unsplash.com/800x600/?fennel,seeds', alt: 'Fennel seeds' },
      { id: 'ajwain', name: 'Ajwain (Carom)', nepali: 'Ajwain', dev: 'अजवाइन', desc: 'Thyme-like seeds used for digestion and tempering.', price: 2.59, image: 'https://source.unsplash.com/800x600/?ajwain,seeds,carom', alt: 'Ajwain seeds' },
      { id: 'kalonji', name: 'Nigella / Kalonji', nepali: 'Kalo Jeera / Kalonji', dev: 'कलौंजी / काला जीरा', desc: 'Pungent seeds used on breads and pickles.', price: 2.89, image: 'https://source.unsplash.com/800x600/?nigella,kalonji,seeds', alt: 'Nigella seeds' },
      { id: 'til', name: 'Sesame Seeds (Til)', nepali: 'Til', dev: 'तिल', desc: 'White/black sesame seeds used in sweets, breads and chutneys.', price: 1.99, image: 'https://source.unsplash.com/800x600/?sesame,seeds', alt: 'Sesame seeds' },
      { id: 'posto', name: 'Poppy Seeds (Posto)', nepali: 'Posto', dev: 'पोस्तो', desc: 'Used as a paste or garnish in some regional dishes.', price: 3.49, image: 'https://source.unsplash.com/800x600/?poppy,seeds,posto', alt: 'Poppy seeds in a bowl' },
      { id: 'elaichi', name: 'Green Cardamom (Elaichi)', nepali: 'Elaichi', dev: 'इलाइची', desc: 'Fragrant pods for sweets, tea and savoury dishes.', price: 5.99, image: 'https://source.unsplash.com/800x600/?cardamom,green', alt: 'Green cardamom pods' },
      { id: 'kali-elaichi', name: 'Black Cardamom', nepali: 'Kali Elaichi', dev: 'कालो इलाइची', desc: 'Smokier cardamom for slow-cooked dishes.', price: 4.99, image: 'https://source.unsplash.com/800x600/?black,cardamom', alt: 'Black cardamom pods' },
      { id: 'lavang', name: 'Cloves (Lavang)', nepali: 'Lavang', dev: 'लवंग', desc: 'Warm, aromatic cloves used in masalas and rice dishes.', price: 4.49, image: 'https://source.unsplash.com/800x600/?cloves,lavang', alt: 'Cloves' },
      { id: 'dalchini', name: 'Cinnamon (Dalchini)', nepali: 'Dalchini', dev: 'दालचिनी', desc: 'Sweet-warm cinnamon bark for curries and desserts.', price: 3.99, image: 'https://source.unsplash.com/800x600/?cinnamon,sticks', alt: 'Cinnamon sticks' },
      { id: 'tejpat', name: 'Bay Leaf (Tejpat)', nepali: 'Tejpat', dev: 'तेजपात', desc: 'Aromatic leaf used in stews and rice.', price: 1.49, image: 'https://source.unsplash.com/800x600/?bay,leaf,tejpat', alt: 'Bay leaves' },
      { id: 'jaiphal', name: 'Nutmeg (Jaiphal)', nepali: 'Jaiphal', dev: 'जायफल', desc: 'Used sparingly for warm, nutty aroma in gravies and sweets.', price: 6.50, image: 'https://source.unsplash.com/800x600/?nutmeg,jaiphal', alt: 'Nutmeg' },
      { id: 'javitri', name: 'Mace (Javitri)', nepali: 'Javitri', dev: 'जावित्री', desc: 'Aroma-rich sister spice to nutmeg.', price: 7.50, image: 'https://source.unsplash.com/800x600/?mace,javitri', alt: 'Mace (javitri)' },
      { id: 'star-anise', name: 'Star Anise', nepali: 'Chakriphool', dev: 'चक्रफूल', desc: 'Sweet licorice-like spice for broths and biryanis.', price: 3.99, image: 'https://source.unsplash.com/800x600/?star,anise', alt: 'Star anise' },
      { id: 'pipli', name: 'Long Pepper (Pipli)', nepali: 'Pipli', dev: 'पिप्पली', desc: 'Historic pepper similar to black pepper (less common).', price: 5.99, image: 'https://source.unsplash.com/800x600/?long,pepper,pipli', alt: 'Long pepper (pipli)' },
      { id: 'hing', name: 'Asafoetida (Hing)', nepali: 'Hing', dev: 'हींग', desc: 'Strong aromatic used in small amounts in lentils and vegetables.', price: 4.25, image: 'https://source.unsplash.com/800x600/?asafoetida,hing', alt: 'Asafoetida' },
      { id: 'aduwa', name: 'Ginger (Aduwa)', nepali: 'Aduwa', dev: 'अदुवा', desc: 'Fresh or dried ginger used everywhere in Nepali cooking.', price: 2.99, image: 'https://source.unsplash.com/800x600/?ginger,root', alt: 'Fresh ginger root' },
      { id: 'lasun', name: 'Garlic (Lasun)', nepali: 'Lasun', dev: 'लसुन', desc: 'Fresh or dried garlic used widely for flavour.', price: 2.49, image: 'https://source.unsplash.com/800x600/?garlic,cloves', alt: 'Garlic cloves' },
      { id: 'timur', name: 'Timur (Nepalese pepper)', nepali: 'Timur', dev: 'तिमुर', desc: 'Citrusy, slightly numbing Sichuan-like pepper unique to Nepal.', price: 6.99, image: 'https://source.unsplash.com/800x600/?sichuan,pepper,peppercorn', alt: 'Timur peppercorns' },
      { id: 'jimbu', name: 'Jimbu', nepali: 'Jimbu', dev: 'जिम्बु', desc: 'Dried highland herb iconic to Nepali/Himalayan cooking.', price: 5.49, image: 'https://source.unsplash.com/800x600/?dried,herbs,jimbu', alt: 'Dried jimbu herb' },
      { id: 'radhuni', name: 'Radhuni', nepali: 'Radhuni', dev: 'रधुनि', desc: 'Aromatic seed (like wild celery) used in soups and pickles.', price: 3.99, image: 'https://source.unsplash.com/800x600/?wild,celery,seeds', alt: 'Radhuni seeds' },
      { id: 'garam-masala', name: 'Garam Masala (Blend)', nepali: 'Garam Masala', dev: 'गरम मसला', desc: 'House blend of warming whole spices (varies by recipe).', price: 4.99, image: 'https://source.unsplash.com/800x600/?garam,masala,spice', alt: 'Garam masala powder' },
      { id: 'panch-phoran', name: 'Panch Phoran', nepali: 'Panch Phutana', dev: 'पाँच फूटना', desc: 'Five-spice whole blend (fenugreek, nigella, cumin, fennel, mustard).', price: 3.99, image: 'https://source.unsplash.com/800x600/?panch,phoran,spices', alt: 'Panch phoran mix' },
      { id: 'amchur', name: 'Dried Mango Powder (Amchur)', nepali: 'Amchur', dev: 'अमचूर', desc: 'Souring agent used in chutneys and marinades.', price: 3.49, image: 'https://source.unsplash.com/800x600/?amchur,mango,powder', alt: 'Amchur (dried mango powder)' },
      { id: 'imli', name: 'Tamarind (Imli)', nepali: 'Imli', dev: 'इमली', desc: 'Sour chutney ingredient and souring agent.', price: 2.99, image: 'https://source.unsplash.com/800x600/?tamarind,imli', alt: 'Tamarind pods' },
      { id: 'kesar', name: 'Saffron (Kesar)', nepali: 'Kesar', dev: 'केसर', desc: 'Priced spice for color and fragrance; used sparingly.', price: 15.00, image: 'https://source.unsplash.com/800x600/?saffron,kesar', alt: 'Saffron threads' },
      { id: 'gur', name: 'Jaggery (Gur)', nepali: 'Gur', dev: 'गुड़', desc: 'Unrefined sugar used to balance spice blends and sweets.', price: 2.99, image: 'https://source.unsplash.com/800x600/?jaggery,gur', alt: 'Jaggery block' }
    ];

    // UTIL: safe image getter (falls back to placeholder svg if remote fails)
    function imageFor(p) {
      return p.image || 'images/placeholder.svg';
    }

    // embedded SVG fallback (data URI) in case images/placeholder.svg isn't present
    const DATA_SVG_PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="800" height="500" viewBox="0 0 800 500">
        <rect width="100%" height="100%" fill="#f4efe9"/>
        <g fill="#9a8f83" font-family="Segoe UI, Arial, sans-serif">
          <text x="50%" y="44%" dominant-baseline="middle" text-anchor="middle" font-size="36">Image placeholder</text>
          <text x="50%" y="56%" dominant-baseline="middle" text-anchor="middle" font-size="18">Timalsina Masala</text>
        </g>
      </svg>
    `);

    /*************************************************************************
     * CART - localStorage keyed 'cart'
     *************************************************************************/
    function loadCart() {
      try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch (e) { return []; }
    }
    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
      try { localStorage.setItem('cart_updated_at', Date.now()); } catch(e){}
      updateCartCount();
    }

    function updateCartCount() {
      const cart = loadCart();
      const count = cart.reduce((s, i) => s + (i.qty || 0), 0);
      const el = document.getElementById('cart-count');
      if (el) el.textContent = count;
    }

    function addToCart(product) {
      const cart = loadCart();
      const existing = cart.find(i => i.id === product.id);
      if (existing) existing.qty += 1;
      else cart.push({ id: product.id, name: product.name, price: product.price, qty: 1 });
      saveCart(cart);
      renderCart();
      // small visual feedback
      const btn = document.querySelector(`button[data-id="${product.id}"]`);
      if (btn) {
        btn.textContent = 'Added';
        setTimeout(() => btn.textContent = 'Add to Cart', 900);
      }
    }

    function changeQty(id, delta) {
      const cart = loadCart();
      const idx = cart.findIndex(i => i.id === id);
      if (idx === -1) return;
      cart[idx].qty += delta;
      if (cart[idx].qty <= 0) cart.splice(idx, 1);
      saveCart(cart);
      renderCart();
    }

    function removeItem(id) {
      const cart = loadCart().filter(i => i.id !== id);
      saveCart(cart);
      renderCart();
    }

    function renderCart() {
      const cart = loadCart();
      const container = document.getElementById('cart-items');
      const totalEl = document.getElementById('total');
      container.innerHTML = '';
      if (!cart || cart.length === 0) {
        container.innerHTML = '<p>Your cart is empty.</p>';
        totalEl.textContent = '0.00';
        updateCartCount();
        return;
      }
      let sum = 0;
      cart.forEach(item => {
        sum += item.price * item.qty;
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <div><strong>${item.name}</strong><div style="color:#666">${item.qty} × $${item.price.toFixed(2)}</div></div>
          <div class="cart-controls">
            <button class="qty-btn" data-action="dec" data-id="${item.id}" aria-label="Decrease">-</button>
            <button class="qty-btn" data-action="inc" data-id="${item.id}" aria-label="Increase">+</button>
            <button class="remove-btn" data-id="${item.id}" aria-label="Remove">Remove</button>
          </div>
        `;
        container.appendChild(row);
      });
      totalEl.textContent = sum.toFixed(2);

      container.querySelectorAll('.qty-btn').forEach(b => {
        b.addEventListener('click', () => {
          const id = b.dataset.id;
          const action = b.dataset.action;
          changeQty(id, action === 'inc' ? 1 : -1);
        });
      });
      container.querySelectorAll('.remove-btn').forEach(b => {
        b.addEventListener('click', () => removeItem(b.dataset.id));
      });

      updateCartCount();
    }

    document.getElementById('proceed-checkout').addEventListener('click', () => {
      const cart = loadCart();
      if (!cart || cart.length === 0) {
        alert('Your cart is empty. Add items before checking out.');
        return;
      }
      window.location.href = 'checkout.html';
    });

    /*************************************************************************
     * PRODUCT RENDERING, FILTERING, SORTING
     *************************************************************************/
    const productListEl = document.getElementById('product-list');
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort');

    function renderProducts(items) {
      productListEl.innerHTML = '';
      if (!items || items.length === 0) {
        productListEl.innerHTML = '<p>No spices match your search.</p>';
        return;
      }
      items.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-item';

        // create img with onerror fallback to inline svg
        const img = document.createElement('img');
        img.className = 'product-thumb';
        img.alt = p.alt || p.name;
        img.src = imageFor(p);
        img.addEventListener('error', () => {
          if (!img.dataset.fallback) {
            img.src = DATA_SVG_PLACEHOLDER;
            img.dataset.fallback = '1';
          }
        });

        const content = document.createElement('div');
        content.innerHTML = `
          <h3 class="product-name">${p.name}</h3>
          <div class="nepali-name">${p.nepali} — ${p.dev}</div>
          <p class="desc">${p.desc}</p>
        `;

        const bottom = document.createElement('div');
        bottom.className = 'product-bottom';
        bottom.innerHTML = `
          <div class="price">$${p.price.toFixed(2)}</div>
          <button class="add-btn" data-id="${p.id}" aria-label="Add ${p.name} to cart">Add to Cart</button>
        `;

        card.appendChild(img);
        card.appendChild(content);
        card.appendChild(bottom);
        productListEl.appendChild(card);
      });

      // Attach add-to-cart handlers
      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const product = PRODUCTS.find(x => x.id === id);
          if (product) addToCart(product);
        });
      });
    }

    function normalizeText(s) {
      return (s || '').toString().toLowerCase().trim();
    }

    function applyFilters() {
      const q = normalizeText(searchInput.value);
      const sort = sortSelect.value;
      let filtered = PRODUCTS.filter(p => {
        if (!q) return true;
        const hay = `${p.name} ${p.nepali} ${p.dev} ${p.desc}`.toLowerCase();
        return hay.includes(q);
      });

      if (sort === 'az') filtered.sort((a,b) => a.name.localeCompare(b.name));
      else if (sort === 'za') filtered.sort((a,b) => b.name.localeCompare(a.name));
      else if (sort === 'price-asc') filtered.sort((a,b) => a.price - b.price);
      else if (sort === 'price-desc') filtered.sort((a,b) => b.price - a.price);
      // 'popular' keeps original order
      renderProducts(filtered);
      updateGalleryThumbs(filtered);
    }

    searchInput.addEventListener('input', applyFilters);
    sortSelect.addEventListener('change', applyFilters);

    /*************************************************************************
     * GALLERY (placeholder + thumbnails)
     *************************************************************************/
    const mainImageEl = document.getElementById('main-image');
    const thumbsContainer = document.getElementById('gallery-thumbs');

    function updateGalleryThumbs(items) {
      // Show top 8 items' images as thumbnails (or placeholder)
      const thumbs = (items && items.length) ? items.slice(0, 8) : PRODUCTS.slice(0, 8);
      thumbsContainer.innerHTML = '';
      thumbs.forEach((p, idx) => {
        const t = document.createElement('div');
        t.className = 'thumb';
        const img = document.createElement('img');
        img.alt = p.alt || p.name;
        img.src = imageFor(p);
        img.addEventListener('error', () => {
          if (!img.dataset.fallback) {
            img.src = DATA_SVG_PLACEHOLDER;
            img.dataset.fallback = '1';
          }
        });
        t.appendChild(img);
        t.addEventListener('click', () => {
          document.querySelectorAll('.thumb').forEach(el => el.classList.remove('active'));
          t.classList.add('active');
          mainImageEl.src = imageFor(p);
          mainImageEl.alt = p.alt || p.name;
        });
        thumbsContainer.appendChild(t);

        if (idx === 0) {
          // auto-select first after insert
          setTimeout(() => {
            t.classList.add('active');
            mainImageEl.src = imageFor(p);
            mainImageEl.alt = p.alt || p.name;
          }, 0);
        }
      });

      // Ensure mainImage has error fallback
      if (mainImageEl) {
        mainImageEl.addEventListener('error', function () {
          if (this.src !== DATA_SVG_PLACEHOLDER) this.src = DATA_SVG_PLACEHOLDER;
        }, { once: false });
      }

      if (thumbs.length === 0) {
        mainImageEl.src = DATA_SVG_PLACEHOLDER;
        mainImageEl.alt = 'Spice image placeholder';
      }
    }

    /*************************************************************************
     * INITIALIZE
     *************************************************************************/
    // Render initial list and cart
    renderProducts(PRODUCTS);
    renderCart();
    updateCartCount();
    updateGalleryThumbs(PRODUCTS);

    // Listen for storage changes (other tabs) to update cart UI
    window.addEventListener('storage', (e) => {
      if (e.key === 'cart' || e.key === 'cart_updated_at') {
        renderCart();
        updateCartCount();
      }
    });

    // Simple keyboard accessibility: pressing Enter in search focuses product list
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const firstAdd = document.querySelector('.add-btn');
        if (firstAdd) firstAdd.focus();
      }
    });
  </script>
</body>
</html>